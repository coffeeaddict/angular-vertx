"use strict";var vertx=vertx||{},sockJsFactory=function(factory){"function"==typeof define&&define.amd?define("vertxbus",["sockjs"],factory):factory(SockJS)};sockJsFactory(function(SockJS){return vertx.EventBus=function(url,options){function sendPing(){var msg={type:"ping"};sockJSConn.send(JSON.stringify(msg))}function sendOrPub(type,address,message,replyHandler){checkSpecified("address","string",address),checkSpecified("replyHandler","function",replyHandler,!0),checkOpen();var envelope={type:type,address:address,body:message};if(that.sessionID&&(envelope.sessionID=that.sessionID),replyHandler){var replyAddress=makeUUID();envelope.replyAddress=replyAddress,replyHandlers[replyAddress]=replyHandler}var str=JSON.stringify(envelope);sockJSConn.send(str)}function checkOpen(){if(state!==vertx.EventBus.OPEN)throw new Error("INVALID_STATE_ERR")}function checkSpecified(paramName,paramType,param,optional){if(!optional&&!param)throw new Error("Parameter "+paramName+" must be specified");if(param&&typeof param!==paramType)throw new Error("Parameter "+paramName+" must be of type "+paramType)}function makeUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a,b){return b=16*Math.random(),("y"===a?3&b|8:0|b).toString(16)})}var that=this,sockJSConn=new SockJS(url,void 0,options),handlerMap={},replyHandlers={},state=vertx.EventBus.CONNECTING,pingTimerID=null,pingInterval=null,authAddress=null;options&&(pingInterval=options.vertxbus_ping_interval,authAddress=options.vertxbus_auth_manager),pingInterval||(pingInterval=5e3),authAddress||(authAddress="vertx.basicauthmanager"),that.onopen=null,that.onclose=null,that.login=function(username,password,replyHandler){sendOrPub("send",authAddress+".login",{username:username,password:password},function(reply){"ok"===reply.status&&(that.sessionID=reply.sessionID),replyHandler&&(delete reply.sessionID,replyHandler(reply))})},that.send=function(address,message,replyHandler){sendOrPub("send",address,message,replyHandler)},that.publish=function(address,message){sendOrPub("publish",address,message,null)},that.registerHandler=function(address,handler){checkSpecified("address","string",address),checkSpecified("handler","function",handler),checkOpen();var handlers=handlerMap[address];if(handlers)handlers[handlers.length]=handler;else{handlers=[handler],handlerMap[address]=handlers;var msg={type:"register",address:address};sockJSConn.send(JSON.stringify(msg))}},that.unregisterHandler=function(address,handler){checkSpecified("address","string",address),checkSpecified("handler","function",handler),checkOpen();var handlers=handlerMap[address];if(handlers){var idx=handlers.indexOf(handler);if(-1!==idx&&handlers.splice(idx,1),0===handlers.length){var msg={type:"unregister",address:address};sockJSConn.send(JSON.stringify(msg)),delete handlerMap[address]}}},that.close=function(){checkOpen(),state=vertx.EventBus.CLOSING,sockJSConn.close()},that.readyState=function(){return state},sockJSConn.onopen=function(){sendPing(),pingTimerID=setInterval(sendPing,pingInterval),state=vertx.EventBus.OPEN,that.onopen&&that.onopen()},sockJSConn.onclose=function(){state=vertx.EventBus.CLOSED,pingTimerID&&clearInterval(pingTimerID),that.onclose&&that.onclose()},sockJSConn.onmessage=function(e){var replyHandler,msg=e.data,json=JSON.parse(msg),body=json.body,replyAddress=json.replyAddress,address=json.address;replyAddress&&(replyHandler=function(reply,replyHandler){that.send(replyAddress,reply,replyHandler)});var handlers=handlerMap[address];if(handlers)for(var copy=handlers.slice(0),i=0;i<copy.length;i++)copy[i](body,replyHandler);else{var handler=replyHandlers[address];handler&&(delete replyHandlers[address],handler(body,replyHandler))}}},vertx.EventBus.CONNECTING=0,vertx.EventBus.OPEN=1,vertx.EventBus.CLOSING=2,vertx.EventBus.CLOSED=3,vertx.EventBus}),angular.module("vertx",["ng"]).provider("vertxBus",function(){var eb,busLocation="http://localhost:8080/eventbus";this.setBusLocation=function(location){busLocation=location},this.$get=function($q,$rootScope){var waitUntilOpen=function(retries,execute,reject){--retries<=0?reject("Bus did not open timely"):eb.readyState()===vertx.EventBus.CLOSED?api.connect(execute):eb.readyState()===vertx.EventBus.OPEN?execute():setTimeout(function(){waitUntilOpen(retries,execute,reject)},200)},waitUntilClosed=function(retries,execute,reject){--retries<=0?reject("Bus did not close properly"):eb.readyState()===vertx.EventBus.CLOSED?api.connect(execute):eb.readyState()===vertx.EventBus.OPEN?execute():setTimeout(function(){waitUntilOpen(retries,execute,reject)},200)},api={connect:function(onopen){var api=this;if(void 0===eb)eb=new vertx.EventBus(busLocation),eb.onopen=onopen;else{eb.onclose=function(){eb=void 0,api.connect(onopen)};try{eb.close()}catch(e){}}},send:function(address,msg){var d=$q.defer(),execute=function(){api._send(address,msg,d)},retries=10;return void 0===eb?api.connect(execute):eb.readyState()===vertx.EventBus.CLOSED?api.connect(execute):eb.readyState()===vertx.EventBus.CLOSING?setTimeout(function(){waitUntilClosed(retries,execute,d.reject)},200):eb.readyState()===vertx.EventBus.CONNECTING?setTimeout(function(){waitUntilOpen(retries,execute,d.reject)},200):execute(),d.promise},_send:function(address,msg,d){eb.send(address,msg,function(reply){d.resolve(reply),$rootScope.$apply()})}};return api}});